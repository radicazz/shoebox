#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./_nvm-load.sh
source "$SCRIPT_DIR/_nvm-load.sh"
# shellcheck source=./_pkgm.sh
source "$SCRIPT_DIR/_pkgm.sh"

echo "üè• Running environment checks..."
echo "‚öôÔ∏è  Primary package manager: $PKGM_PRETTY_NAME"
echo ""

EXIT_CODE=0

# Check Node.js version
echo "üì¶ Node.js:"
if command -v node &> /dev/null; then
  NODE_VERSION=$(node --version)
  echo "  ‚úì Found: $NODE_VERSION"

  NODE_MAJOR=$(echo "$NODE_VERSION" | sed 's/v\([0-9]*\).*/\1/')
  if [ "$NODE_MAJOR" -lt 18 ]; then
    echo "  ‚ö†Ô∏è  Warning: Node.js 18+ required, found $NODE_VERSION"
    EXIT_CODE=1
  fi
else
  echo "  ‚úó Node.js not found"
  EXIT_CODE=1
fi

# Check package managers
echo ""
echo "üß∞ Package managers:"
if command -v pnpm &> /dev/null; then
  echo "  ‚úì pnpm $(pnpm --version)"
else
  echo "  ‚ö†Ô∏è  pnpm not found (install via Corepack or https://pnpm.io/installation)"
  if [ -z "${SHOEBOX_ALLOW_NPM:-}" ]; then
    echo "     Set SHOEBOX_ALLOW_NPM=1 to bypass this warning."
    EXIT_CODE=1
  fi
fi

if command -v npm &> /dev/null; then
  echo "  ‚úì npm $(npm --version)"
else
  echo "  ‚úó npm not found"
  EXIT_CODE=1
fi

# Check dependencies
echo ""
echo "üìö Dependencies:"
if [ -d node_modules ]; then
  echo "  ‚úì node_modules/ exists"

  for pkg in astro @astrojs/tailwind tailwindcss alpinejs; do
    if [ -d "node_modules/$pkg" ]; then
      echo "  ‚úì $pkg installed"
    else
      echo "  ‚úó $pkg missing"
      EXIT_CODE=1
    fi
  done
else
  echo "  ‚úó node_modules/ not found"
  if command -v pnpm &> /dev/null; then
    echo "  üí° Run 'pnpm install' to install dependencies"
  else
    echo "  üí° Run 'npm install' to install dependencies"
  fi
  EXIT_CODE=1
fi

# Check project structure
echo ""
echo "üìÅ Project structure:"
REQUIRED_DIRS=("src" "src/components" "src/layouts" "src/pages" "src/styles" "public" "public/media")
for dir in "${REQUIRED_DIRS[@]}"; do
  if [ -d "$dir" ]; then
    echo "  ‚úì $dir/"
  else
    echo "  ‚úó $dir/ missing"
    EXIT_CODE=1
  fi

done

REQUIRED_FILES=("package.json" "astro.config.mjs" "tailwind.config.mjs" "public/gallery.json")
for file in "${REQUIRED_FILES[@]}"; do
  if [ -f "$file" ]; then
    echo "  ‚úì $file"
  else
    echo "  ‚úó $file missing"
    EXIT_CODE=1
  fi

done

# Test build
echo ""
echo "üî® Build test:"
if shoebox_pkgm_run build > /tmp/shoebox-build.log 2>&1; then
  echo "  ‚úì Build successful"
  if [ -f dist/index.html ]; then
    SIZE=$(du -sh dist | cut -f1)
    echo "  ‚úì dist/index.html exists ($SIZE total)"
  else
    echo "  ‚úó dist/index.html not found"
    EXIT_CODE=1
  fi
else
  echo "  ‚úó Build failed (see /tmp/shoebox-build.log)"
  EXIT_CODE=1
fi

echo ""
if [ $EXIT_CODE -eq 0 ]; then
  echo "‚úÖ All checks passed! Environment is healthy."
else
  echo "‚ùå Some checks failed. Review the output above."
fi

exit $EXIT_CODE
