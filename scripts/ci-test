#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./_nvm-load.sh
source "$SCRIPT_DIR/_nvm-load.sh"
# shellcheck source=./_pkgm.sh
source "$SCRIPT_DIR/_pkgm.sh"

echo "üß™ Running CI tests..."
echo "‚öôÔ∏è  Package manager: $PKGM_PRETTY_NAME"
echo ""

EXIT_CODE=0

# Install dependencies (fresh)
echo "1Ô∏è‚É£  Installing dependencies..."
if shoebox_pkgm_install_ci; then
  echo "  ‚úì Dependencies installed"
else
  echo "  ‚úó Dependency install failed"
  exit 1
fi

# Validate gallery data
echo ""
echo "2Ô∏è‚É£  Validating gallery.json..."
if [ ! -f public/gallery.json ]; then
  echo "  ‚úó public/gallery.json missing"
  EXIT_CODE=1
else
  if node <<'NODE'
import fs from 'node:fs';
const raw = fs.readFileSync('public/gallery.json', 'utf8');
const data = JSON.parse(raw);
if (!data.profile) {
  throw new Error('Missing profile block');
}
const requiredContact = ['email'];
for (const key of requiredContact) {
  if (!data.profile.contact || !data.profile.contact[key]) {
    throw new Error(`Missing contact.${key}`);
  }
}
if (!data.profile.photo) {
  throw new Error('Missing profile.photo reference');
}
NODE
  then
    echo "  ‚úì gallery.json valid"
  else
    echo "  ‚úó gallery.json validation failed"
    EXIT_CODE=1
  fi
fi

# Build
echo ""
echo "3Ô∏è‚É£  Building production bundle..."
if shoebox_pkgm_run build; then
  echo "  ‚úì Build successful"
else
  echo "  ‚úó Build failed"
  exit 1
fi

# Check bundle size
echo ""
echo "4Ô∏è‚É£  Checking bundle size..."
DIST_SIZE=$(du -sb dist | cut -f1)
DIST_SIZE_KB=$((DIST_SIZE / 1024))

echo "  üì¶ Total size: ${DIST_SIZE_KB}KB"

# Warn if bundle is too large (500KB target per docs)
if [ $DIST_SIZE_KB -gt 500 ]; then
  echo "  ‚ö†Ô∏è  Warning: Bundle exceeds 500KB target"
fi

# Check index.html exists and has content
if [ ! -f dist/index.html ]; then
  echo "  ‚úó dist/index.html not found"
  EXIT_CODE=1
else
  HTML_SIZE=$(wc -c < dist/index.html)
  if [ $HTML_SIZE -lt 100 ]; then
    echo "  ‚úó dist/index.html seems empty ($HTML_SIZE bytes)"
    EXIT_CODE=1
  else
    echo "  ‚úì dist/index.html valid ($HTML_SIZE bytes)"
  fi
fi

echo ""
if [ $EXIT_CODE -eq 0 ]; then
  echo "‚úÖ All CI tests passed!"
else
  echo "‚ùå CI tests failed!"
fi

exit $EXIT_CODE
