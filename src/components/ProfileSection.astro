---
export interface ProfileHeroData {
  name: string;
  photo: string;
  title?: string;
  location?: string;
}

export interface AboutCardData {
  text?: string;
  skills?: string[];
}

export interface Props {
  profileHero: ProfileHeroData;
  aboutCard?: AboutCardData;
}

const { profileHero, aboutCard } = Astro.props as Props;
const isExternal = /^(?:[a-z]+:)?\/\//i;
const normalizedBase = (import.meta.env.BASE_URL ?? '/').replace(/\/$/, '');
const normalizedPhoto = profileHero.photo.replace(/^\//, '');
const defaultPhotoPath = `${normalizedBase ? normalizedBase : ''}/media/profile.svg`;
const fallbackPhoto = normalizedPhoto === 'media/profile.svg' ? null : defaultPhotoPath;
const resolvedPhoto = isExternal.test(profileHero.photo)
  ? profileHero.photo
  : `${normalizedBase ? normalizedBase : ''}/${normalizedPhoto}`;
const skillList = (aboutCard?.skills ?? []).filter(Boolean);

const sourceEntry = {
  label: 'Source',
  value: 'github.com/radicazz/shoe-box',
  href: 'https://github.com/radicazz/shoe-box',
};

const linkEntries = [sourceEntry];

const sectionHeadingClass = 'theme-text-muted text-sm font-semibold uppercase tracking-wide';
const sectionBodyClass = 'mt-4 text-base leading-relaxed';
---
<section class="profile-section" aria-label="Profile overview">
  <div class="grid items-center gap-12 md:grid-cols-[auto,1fr] lg:gap-16">
    <div class="flex flex-col items-center gap-8 text-center">
      <div class="inline-flex rounded-full">
        <img
          src={resolvedPhoto}
          data-profile-photo="true"
          data-fallback-src={fallbackPhoto ?? undefined}
          alt={`Photo of ${profileHero.name}`}
          width="180"
          height="180"
          loading="eager"
          class="h-[160px] w-[160px] rounded-full object-cover ring-4 ring-white ring-offset-4 ring-offset-gray-50 dark:ring-gray-900 dark:ring-offset-gray-800 sm:h-[180px] sm:w-[180px] lg:h-[200px] lg:w-[200px]"
        />
      </div>
      <div>
        <h2 class="theme-heading mt-3 text-4xl font-bold">{profileHero.name}</h2>
        {(profileHero.title || profileHero.location) && (
          <p class="theme-text-muted mt-3 flex flex-wrap items-center justify-center gap-2 text-base font-medium">
            {profileHero.title && <span>{profileHero.title}</span>}
            {profileHero.title && profileHero.location && <span aria-hidden="true" class="theme-text-muted">â€¢</span>}
            {profileHero.location && <span>{profileHero.location}</span>}
          </p>
        )}
        <p id="profile-clock" class="theme-text-muted mt-3 text-sm font-mono tracking-wide text-center">--:--:--</p>
      </div>
    </div>
    {(aboutCard?.text || skillList.length > 0) && (
      <div class="flex flex-col gap-8 text-left">
        {aboutCard?.text && (
          <div>
            <p class={sectionHeadingClass}>About</p>
            <p class={sectionBodyClass}>{aboutCard.text}</p>
          </div>
        )}
        {skillList.length > 0 && (
          <div>
            <p class={sectionHeadingClass}>Skills</p>
            <ul class={`mt-4 flex flex-wrap gap-3 text-base leading-relaxed`}>
              {skillList.map((skill) => (
                <li class="theme-chip px-4 py-2 text-sm font-medium md:text-base">{skill}</li>
              ))}
            </ul>
          </div>
        )}
        {linkEntries.length > 0 && (
          <div>
            <p class={sectionHeadingClass}>Source</p>
            <div class={sectionBodyClass}>
              {linkEntries.map((entry) => (
                <a
                  href={entry.href}
                  target={entry.href.startsWith('http') ? '_blank' : undefined}
                  rel={entry.href.startsWith('http') ? 'noopener noreferrer' : undefined}
                  class="theme-accent-link text-base font-medium"
                >
                  {entry.value}
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    )}
  </div>
</section>

<script is:inline>
  (() => {
    if (typeof window === 'undefined') return;
    const profilePhoto = document.querySelector('[data-profile-photo]');
    if (profilePhoto instanceof HTMLImageElement) {
      const fallbackSrc = profilePhoto.getAttribute('data-fallback-src');
      if (fallbackSrc) {
        profilePhoto.addEventListener('error', () => {
          if (profilePhoto.dataset.fallbackApplied === 'true') return;
          profilePhoto.dataset.fallbackApplied = 'true';
          profilePhoto.src = fallbackSrc;
        });
      }
    }

    const windowClock = document.getElementById('window-clock');
    const browserLabel = document.getElementById('window-browser');
    const profileClock = document.getElementById('profile-clock');
    if (!windowClock || !browserLabel || !profileClock) return;

    const detectBrowserName = () => {
      const ua = navigator.userAgent;
      if (/OPR|Opera/i.test(ua)) return 'OPERA';
      if (/Edg/i.test(ua)) return 'EDGE';
      if (/Chrome/i.test(ua)) return 'CHROME';
      if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) return 'SAFARI';
      if (/Firefox/i.test(ua)) return 'FIREFOX';
      return 'BROWSER';
    };

    browserLabel.textContent = detectBrowserName();

    const sanitize = (value) => {
      if (!value) return '';
      return String(value).replace(/[^\w\s\-.,()\/@]/g, '');
    };

    const infoMessages = [];
    let infoIndex = 0;
    let rotationTimer = null;

    windowClock.textContent = 'gathering client info...';

    const updateProfileClock = () => {
      try {
        profileClock.textContent = new Date().toLocaleTimeString(undefined, {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false,
        });
      } catch {
        profileClock.textContent = new Date().toLocaleTimeString();
      }
    };

    const rotateInfo = () => {
      if (!infoMessages.length) return;
      infoIndex = (infoIndex + 1) % infoMessages.length;
      windowClock.textContent = infoMessages[infoIndex];
    };

    const setInfoMessages = (parts) => {
      infoMessages.splice(0, infoMessages.length, ...(parts.length ? parts : ['client info unavailable']));
      infoIndex = 0;
      windowClock.textContent = infoMessages[0];
      if (rotationTimer) {
        clearInterval(rotationTimer);
        rotationTimer = null;
      }
      if (infoMessages.length > 1) {
        rotationTimer = setInterval(rotateInfo, 3000);
      }
    };

    const collectInfo = async () => {
      const parts = [];
      const lang = sanitize(navigator.language || 'n/a');
      const tz = sanitize(Intl.DateTimeFormat().resolvedOptions().timeZone || 'n/a');
      parts.push(`lang ${lang}`);
      parts.push(`tz ${tz}`);

      try {
        const response = await fetch('https://ipapi.co/json/', { cache: 'no-store' });
        if (response.ok) {
          const data = await response.json();
          if (data.ip) parts.push(`ip ${sanitize(data.ip)}`);
          const location = [data.city, data.region, data.country_name].filter(Boolean).join(', ');
          if (location) parts.push(`loc ${sanitize(location)}`);
          if (data.org) parts.push(`isp ${sanitize(data.org)}`);
        }
      } catch (error) {
        console.warn('Unable to fetch IP info', error);
      } finally {
        setInfoMessages(parts);
      }
    };

    updateProfileClock();
    setInterval(updateProfileClock, 1000);
    collectInfo();
  })();
</script>