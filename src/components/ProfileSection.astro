---
export interface ProfileHeroData {
  name: string;
  photo: string;
  title?: string;
  location?: string;
}

export interface AboutCardData {
  text?: string;
  skills?: string[];
}

export interface Props {
  profileHero: ProfileHeroData;
  aboutCard?: AboutCardData;
}

const { profileHero, aboutCard } = Astro.props as Props;
const isExternal = /^(?:[a-z]+:)?\/\//i;
const normalizedBase = (import.meta.env.BASE_URL ?? '/').replace(/\/$/, '');
const normalizedPhoto = profileHero.photo.replace(/^\//, '');
const defaultPhotoPath = `${normalizedBase ? normalizedBase : ''}/media/profile.svg`;
const fallbackPhoto = normalizedPhoto === 'media/profile.svg' ? null : defaultPhotoPath;
const resolvedPhoto = isExternal.test(profileHero.photo)
  ? profileHero.photo
  : `${normalizedBase ? normalizedBase : ''}/${normalizedPhoto}`;
const skillList = (aboutCard?.skills ?? []).filter(Boolean);
const initialTitle = (profileHero.title ?? '').trim() || 'detecting country...';
const initialLocation = (profileHero.location ?? '').trim() || 'detecting ip...';
const hasInitialDivider = Boolean(initialTitle && initialLocation);

const profileLinks = [
  { label: 'github.com/cazzwastaken', href: 'https://github.com/cazzwastaken' },
  { label: 'github.com/radicazz', href: 'https://github.com/radicazz' },
  { label: 'github.com/czrch', href: 'https://github.com/czrch' },
];

const skillRows = (() => {
  if (!skillList.length) return [];
  const midpoint = Math.ceil(skillList.length / 2);
  const rows = [skillList.slice(0, midpoint)];
  const secondRow = skillList.slice(midpoint);
  if (secondRow.length) rows.push(secondRow);
  return rows;
})();

const sectionHeadingClass = 'theme-text-muted text-sm font-semibold uppercase tracking-wide';
const sectionBodyClass = 'mt-4 text-base leading-relaxed';
---
<section class="profile-section px-5 sm:px-10 lg:px-16" aria-label="Profile overview">
  <div class="grid items-center gap-12 md:grid-cols-[auto,1fr] lg:gap-16">
    <div class="flex flex-col items-center gap-8 text-center">
      <div class="inline-flex rounded-full">
        <img
          src={resolvedPhoto}
          data-profile-photo="true"
          data-fallback-src={fallbackPhoto ?? undefined}
          alt={`Photo of ${profileHero.name}`}
          width="180"
          height="180"
          loading="eager"
          class="h-[160px] w-[160px] rounded-full object-cover ring-4 ring-white ring-offset-4 ring-offset-gray-50 dark:ring-gray-900 dark:ring-offset-gray-800 sm:h-[180px] sm:w-[180px] lg:h-[200px] lg:w-[200px]"
        />
      </div>
      <div>
        <h2 class="theme-heading mt-3 text-4xl font-bold">{profileHero.name}</h2>
        <p class="mt-2 text-sm font-medium">
          <a
            href="https://github.com/radicazz/shoe-box"
            target="_blank"
            rel="noopener noreferrer"
            class="theme-accent-link"
          >
            radicazz/shoe-box
          </a>
        </p>
        <p class="theme-text-muted mt-3 flex flex-wrap items-center justify-center gap-2 text-base font-medium">
          <span id="profile-title">{initialTitle}</span>
          <span
            id="profile-divider"
            aria-hidden="true"
            class="theme-text-muted"
            style={`display: ${hasInitialDivider ? 'inline' : 'none'};`}
          >
            â€¢
          </span>
          <span id="profile-location">{initialLocation}</span>
        </p>
      </div>
    </div>
    {(aboutCard?.text || skillRows.length > 0 || profileLinks.length > 0) && (
      <div class="flex flex-col gap-8 text-left">
        {aboutCard?.text && (
          <div>
            <p class={sectionHeadingClass}>About</p>
            <p class={sectionBodyClass}>{aboutCard.text}</p>
          </div>
        )}
        {(skillRows.length > 0 || profileLinks.length > 0) && (
          <div class="grid gap-8 lg:grid-cols-2 lg:items-start">
            {skillRows.length > 0 && (
              <div>
                <p class={sectionHeadingClass}>Skills</p>
                <div class="mt-4 space-y-3">
                  {skillRows.map((row, index) => (
                    <div class="flex flex-wrap justify-start gap-3" aria-label={`Skill line ${index + 1}`}>
                      {row.map((skill) => (
                        <span class="theme-chip px-4 py-2 text-sm font-medium md:text-base">{skill}</span>
                      ))}
                    </div>
                  ))}
                </div>
              </div>
            )}
            {profileLinks.length > 0 && (
              <div>
                <p class={sectionHeadingClass}>Links</p>
                <ul class="mt-4 space-y-3 text-base font-medium leading-relaxed">
                  {profileLinks.map((entry) => (
                    <li>
                      <a href={entry.href} target="_blank" rel="noopener noreferrer" class="theme-accent-link">
                        {entry.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        )}
      </div>
    )}
  </div>
</section>

<script is:inline>
  (() => {
    if (typeof window === 'undefined') return;
    const profilePhoto = document.querySelector('[data-profile-photo]');
    if (profilePhoto instanceof HTMLImageElement) {
      const fallbackSrc = profilePhoto.getAttribute('data-fallback-src');
      if (fallbackSrc) {
        profilePhoto.addEventListener('error', () => {
          if (profilePhoto.dataset.fallbackApplied === 'true') return;
          profilePhoto.dataset.fallbackApplied = 'true';
          profilePhoto.src = fallbackSrc;
        });
      }
    }

    const windowTimeLabel = document.getElementById('gallery-viewport');
    const profileTitleLabel = document.getElementById('profile-title');
    const profileLocationLabel = document.getElementById('profile-location');
    const profileDivider = document.getElementById('profile-divider');
    if (!windowTimeLabel) return;

    const syncProfileMeta = () => {
      if (!profileDivider) return;
      const hasTitle = Boolean(profileTitleLabel?.textContent?.trim());
      const hasLocation = Boolean(profileLocationLabel?.textContent?.trim());
      profileDivider.style.display = hasTitle && hasLocation ? '' : 'none';
    };

    const sanitize = (value) => {
      if (!value) return '';
      return String(value).replace(/[^\w\s\-.,()\/@]/g, '');
    };

    const formatTime = () => {
      try {
        return new Date().toLocaleTimeString(undefined, {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false,
        });
      } catch {
        return new Date().toLocaleTimeString();
      }
    };

    const updateWindowTime = () => {
      windowTimeLabel.textContent = formatTime();
    };

    const collectInfo = async () => {
      try {
        const response = await fetch('https://ipapi.co/json/', { cache: 'no-store' });
        if (response.ok) {
          const data = await response.json();
          if (data.ip) {
            const cleanIp = sanitize(data.ip);
            if (profileLocationLabel) profileLocationLabel.textContent = cleanIp;
          }
          const country = sanitize(data.country_name || data.country);
          if (country && profileTitleLabel) {
            profileTitleLabel.textContent = country;
          }
        }
      } catch (error) {
        console.warn('Unable to fetch IP info', error);
      } finally {
        syncProfileMeta();
      }
    };

    updateWindowTime();
    setInterval(updateWindowTime, 1000);
    syncProfileMeta();
    collectInfo();
  })();
</script>
