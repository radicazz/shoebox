---
import { composeEffects } from '../../utils/effects';

export interface GalleryItemData {
  id: string;
  title: string;
  description: string;
  image?: string;
  imageDark?: string;
  imageLight?: string;
  size?: 'text' | 'tall' | 'wide' | string;
  tags?: string[];
  link?: string;
  details?: {
    fullDescription: string;
    images: string[];
    tech: string[];
    date: string;
    link?: string;
  };
}

export interface Props {
  item: GalleryItemData;
}

const { item } = Astro.props as Props;
const basePath = (import.meta.env.BASE_URL ?? '/').replace(/\/$/, '');
const resolveImagePath = (value?: string | null) => {
  if (!value) return null;
  return value.startsWith('/') ? `${basePath}${value}` : value;
};

const resolvedLight = resolveImagePath(item.imageLight ?? item.image);
const resolvedDark = resolveImagePath(item.imageDark ?? item.image);
const fallbackImage = resolvedLight ?? resolvedDark;
const hasImage = Boolean(fallbackImage);
const linkTarget = item.link ?? item.details?.link ?? null;

// Size-based classes for masonry layout
const sizeClasses: Record<string, string> = {
  text: 'gallery-item-text',
  tall: 'gallery-item-tall',
  wide: 'gallery-item-wide',
};

const itemSizeClass = item.size ? (sizeClasses[item.size] || '') : '';
const variantClass = hasImage ? 'gallery-item--has-image' : 'gallery-item--no-image';
const baseClasses = `gallery-item ${itemSizeClass} ${variantClass} theme-panel effect-card-base group relative overflow-hidden ${composeEffects(
  'shadow',
  'scale',
)} cursor-pointer`;

const interactiveAttributes = linkTarget
  ? {
      href: linkTarget,
      target: '_blank',
      rel: 'noopener noreferrer',
      class: `${baseClasses} block`,
    }
  : {
      class: baseClasses,
      role: 'button',
      tabindex: 0,
      'aria-label': `Open details for ${item.title}`,
    };

const Tag = (linkTarget ? 'a' : 'article') as 'a' | 'article';
---

<Tag {...interactiveAttributes}>
  {hasImage && (
    <div class="gallery-item-image-wrapper relative overflow-hidden">
      <img
        src={fallbackImage ?? ''}
        alt={item.title}
        loading="lazy"
        class="gallery-item-image h-full w-full object-cover transition-transform duration-[650ms] ease-out will-change-transform group-hover:scale-110"
        data-theme-image
        data-theme-src-light={resolvedLight ?? undefined}
        data-theme-src-dark={resolvedDark ?? undefined}
      />
      <div class="gallery-item-overlay absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent opacity-0 transition-opacity duration-300 group-hover:opacity-100"></div>
    </div>
  )}

  <div class={`gallery-item-content p-6 ${hasImage ? 'gallery-item-content--overlay' : 'gallery-item-content--card'}`}>
    <h3 class={`theme-heading text-xl font-bold leading-tight ${hasImage ? 'mb-1.5' : 'mb-2'}`}>
      {item.title}
    </h3>

    <p class={`theme-text-muted leading-relaxed ${hasImage ? 'text-sm md:text-base mb-3' : 'text-sm mb-4'}`}>
      {item.description}
    </p>

    {item.tags && item.tags.length > 0 && (
      <div class={`flex flex-wrap gap-2 ${hasImage ? 'mt-1.5' : ''}`}>
        {item.tags.map((tag) => (
          <span class="theme-chip px-2.5 py-1 text-xs font-medium">
            {tag}
          </span>
        ))}
      </div>
    )}
  </div>

  <div class="gallery-item-hover-indicator absolute bottom-4 right-4 z-30 flex h-8 w-8 items-center justify-center rounded-full bg-white/10 backdrop-blur-sm opacity-0 transition-all duration-300 group-hover:opacity-100 dark:bg-gray-800/50">
    <svg class="h-4 w-4 text-white dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
  </div>
</Tag>

<style>
  .gallery-item {
    break-inside: avoid;
    display: flex;
    flex-direction: column;
    transition: transform 350ms ease, box-shadow 350ms ease;
    transform-origin: center;
  }

  .gallery-item::before {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    padding: 1.5px;
    background: linear-gradient(
      120deg,
      rgba(251, 191, 36, 0.85),
      rgba(239, 68, 68, 0.85),
      rgba(14, 165, 233, 0.85),
      rgba(251, 191, 36, 0.85)
    );
    background-size: 240% 240%;
    animation: gallery-chroma-border 8s ease infinite;
    opacity: 0;
    transition: opacity 350ms ease;
    pointer-events: none;
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
  }

  .gallery-item--has-image {
    display: block;
  }

  .gallery-item-text {
    min-height: 200px;
  }

  .gallery-item-tall .gallery-item-image-wrapper {
    height: 400px;
  }

  .gallery-item-wide .gallery-item-image-wrapper {
    height: 250px;
  }

  .gallery-item:not(.gallery-item-text):not(.gallery-item-tall):not(.gallery-item-wide) .gallery-item-image-wrapper {
    height: 300px;
  }

  .gallery-item-image {
    display: block;
    transition: filter 400ms ease, transform 650ms ease;
  }

  .gallery-item--has-image .gallery-item-image {
    filter: contrast(1.05) brightness(0.92) saturate(1.05);
  }

  .gallery-item:hover,
  .gallery-item:focus-visible {
    transform: translateY(-6px) scale(1.02);
  }

  .gallery-item:hover::before,
  .gallery-item:focus-visible::before {
    opacity: 1;
  }

  /* Keyboard focus styles */
  .gallery-item:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 4px;
  }

  .gallery-item-content {
    position: relative;
    transition: transform 300ms ease;
  }

  .gallery-item-content--card {
    background: transparent;
  }

  .gallery-item-content--overlay {
    position: absolute;
    inset: auto 0 0 0;
    z-index: 2;
    padding: 1.5rem;
    padding-top: clamp(2.5rem, 5vw, 4.25rem);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    background: linear-gradient(
      180deg,
      rgba(5, 10, 24, 0) 0%,
      rgba(5, 10, 24, 0.45) 45%,
      rgba(4, 7, 16, 0.92) 100%
    );
    color: #f8fafc;
    text-shadow: 0 1px 2px rgba(1, 2, 6, 0.55);
    backdrop-filter: blur(12px) saturate(140%);
    -webkit-backdrop-filter: blur(12px) saturate(140%);
  }

  .gallery-item-content--overlay .theme-heading {
    color: #fff;
  }

  .gallery-item-content--overlay .theme-text-muted {
    color: rgba(248, 250, 252, 0.9);
  }

  .gallery-item-content--overlay .theme-chip {
    border-color: rgba(248, 250, 252, 0.35);
    background-color: rgba(15, 23, 42, 0.35);
    color: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(4px);
  }

  .gallery-item--no-image:hover .gallery-item-content {
    transform: translateY(-4px);
  }

  @keyframes gallery-chroma-border {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }
</style>
