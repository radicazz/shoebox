---
import { getImage } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import { composeEffects } from '../../utils/effects';

export interface GalleryItemData {
  id: string;
  title: string;
  description: string;
  image?: string | ImageMetadata;
  imageDark?: string | ImageMetadata;
  imageLight?: string | ImageMetadata;
  size?: 'text' | 'tall' | 'wide' | string;
  tags?: string[];
  link?: string;
  details?: {
    fullDescription: string;
    images: string[];
    tech: string[];
    date: string;
    link?: string;
  };
}

export interface Props {
  item: GalleryItemData;
}

const { item } = Astro.props as Props;
const basePath = (import.meta.env.BASE_URL ?? '/').replace(/\/$/, '');
const resolveImagePath = (value?: string | null) => {
  if (!value) return null;
  return value.startsWith('/') ? `${basePath}${value}` : value;
};

const isImageMetadata = (value: unknown): value is ImageMetadata =>
  typeof value === 'object' && value !== null && 'src' in value;
const imageWidths = [320, 480, 640, 800, 1024];
const imageSizes = '(min-width: 1280px) 360px, (min-width: 768px) 42vw, 90vw';
const imageFormats = ['avif', 'webp'] as const;
const fallbackFormat = 'png';

const lightImage = item.imageLight ?? item.image ?? null;
const darkImage = item.imageDark ?? item.image ?? null;
const primaryImage = lightImage ?? darkImage;
const hasImage = Boolean(primaryImage);
const getImageIdentity = (value: string | ImageMetadata | null) =>
  typeof value === 'string' ? value : value?.src;
const hasThemedImages =
  Boolean(lightImage && darkImage) && getImageIdentity(lightImage) !== getImageIdentity(darkImage);

const resolveImageSet = async (source: ImageMetadata) => {
  const sources = await Promise.all(
    imageFormats.map(async (format) => {
      const result = await getImage({ src: source, format, widths: imageWidths, sizes: imageSizes });
      return {
        format,
        srcset: result.srcSet.attribute,
      };
    }),
  );
  const fallback = await getImage({ src: source, format: fallbackFormat, widths: imageWidths, sizes: imageSizes });
  return { sources, fallback };
};

const lightImageSet = isImageMetadata(lightImage) ? await resolveImageSet(lightImage) : null;
const primaryImageSet =
  !lightImageSet && isImageMetadata(primaryImage) ? await resolveImageSet(primaryImage) : null;
const darkImageSet =
  hasThemedImages && isImageMetadata(darkImage) ? await resolveImageSet(darkImage) : null;

const displayImageSet = lightImageSet ?? primaryImageSet;
const fallbackImagePath =
  !displayImageSet && typeof primaryImage === 'string' ? resolveImagePath(primaryImage) : null;

const linkTarget = item.link ?? item.details?.link ?? null;

// Size-based classes for masonry layout
const sizeClasses: Record<string, string> = {
  text: 'gallery-item-text',
  tall: 'gallery-item-tall',
  wide: 'gallery-item-wide',
};

const itemSizeClass = item.size ? (sizeClasses[item.size] || '') : '';
const variantClass = hasImage ? 'gallery-item--has-image' : 'gallery-item--no-image';
const interactionClass = linkTarget ? 'gallery-item--interactive cursor-pointer' : 'cursor-default';
const baseClasses = `gallery-item ${itemSizeClass} ${variantClass} ${interactionClass} theme-panel effect-card-base relative overflow-hidden ${composeEffects(
  'shadow',
  'scale',
)}`;

const interactiveAttributes = linkTarget
  ? {
      href: linkTarget,
      target: '_blank',
      rel: 'noopener noreferrer',
      class: `${baseClasses} block`,
    }
  : {
      class: baseClasses,
    };

const Tag = (linkTarget ? 'a' : 'article') as 'a' | 'article';
---

<Tag {...interactiveAttributes}>
  {hasImage && (
    <div class="gallery-item-image-wrapper relative overflow-hidden">
      {displayImageSet ? (
        <picture data-theme-image>
          {displayImageSet.sources.map((source, index) => {
            const darkSource = darkImageSet?.sources[index];
            const lightSrcset = source.srcset;
            const darkSrcset = darkSource?.srcset;
            const type = `image/${source.format}`;
            return (
              <source
                srcset={lightSrcset}
                sizes={imageSizes}
                type={type}
                data-theme-srcset-light={lightSrcset}
                data-theme-srcset-dark={darkSrcset ?? undefined}
              />
            );
          })}
          {(() => {
            const { class: _className, ...imgAttributes } = displayImageSet.fallback.attributes;
            const lightSrc = displayImageSet.fallback.src;
            const lightSrcset = displayImageSet.fallback.srcSet.attribute;
            const darkSrc = darkImageSet?.fallback.src;
            const darkSrcset = darkImageSet?.fallback.srcSet.attribute;
            return (
              <img
                src={lightSrc}
                srcset={lightSrcset}
                sizes={imageSizes}
                {...imgAttributes}
                alt=""
                loading="lazy"
                decoding="async"
                class="gallery-item-image h-full w-full object-cover transition-transform duration-[650ms] ease-out will-change-transform"
                data-theme-src-light={lightSrc}
                data-theme-src-dark={darkSrc ?? undefined}
                data-theme-srcset-light={lightSrcset}
                data-theme-srcset-dark={darkSrcset ?? undefined}
                aria-hidden="true"
              />
            );
          })()}
        </picture>
      ) : (
        <img
          src={fallbackImagePath ?? ''}
          alt=""
          loading="lazy"
          decoding="async"
          class="gallery-item-image h-full w-full object-cover transition-transform duration-[650ms] ease-out will-change-transform"
          data-theme-image
          aria-hidden="true"
        />
      )}
      <div class="gallery-item-overlay absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent opacity-0 transition-opacity duration-300"></div>
    </div>
  )}

  <div class={`gallery-item-content p-6 ${hasImage ? 'gallery-item-content--overlay' : 'gallery-item-content--card'}`}>
    <h3 class={`theme-heading text-xl font-bold leading-tight ${hasImage ? 'mb-1.5' : 'mb-2'}`}>
      {item.title}
    </h3>

    <p class={`theme-text-muted leading-relaxed ${hasImage ? 'text-sm md:text-base mb-3' : 'text-sm mb-4'}`}>
      {item.description}
    </p>

    {item.tags && item.tags.length > 0 && (
      <div class={`flex flex-wrap gap-2 ${hasImage ? 'mt-1.5' : ''}`}>
        {item.tags.map((tag) => (
          <span class="theme-chip px-2.5 py-1 text-xs font-medium">
            {tag}
          </span>
        ))}
      </div>
    )}
  </div>

  {linkTarget && (
    <div class="gallery-item-hover-indicator absolute bottom-4 right-4 z-30 flex h-8 w-8 items-center justify-center rounded-full bg-white/10 backdrop-blur-sm opacity-0 transition-all duration-300 dark:bg-gray-800/50">
      <svg class="h-4 w-4 text-white dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </div>
  )}
</Tag>

<style>
  .gallery-item {
    break-inside: avoid;
    display: flex;
    flex-direction: column;
    transition: transform 350ms ease, box-shadow 350ms ease;
    transform-origin: center;
  }

  .gallery-item::before {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    padding: 1.5px;
    background: linear-gradient(
      120deg,
      rgba(34, 211, 238, 0.8),
      rgba(168, 85, 247, 0.65),
      rgba(6, 182, 212, 0.75)
    );
    opacity: 0;
    transition: opacity 350ms ease;
    pointer-events: none;
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
  }

  .gallery-item--has-image {
    display: block;
  }

  .gallery-item-text {
    min-height: 200px;
  }

  .gallery-item-tall .gallery-item-image-wrapper {
    height: 25rem;
  }

  .gallery-item-wide .gallery-item-image-wrapper {
    height: 15.625rem;
  }

  .gallery-item:not(.gallery-item-text):not(.gallery-item-tall):not(.gallery-item-wide) .gallery-item-image-wrapper {
    height: 18.75rem;
  }

  .gallery-item-image {
    display: block;
    transition: filter 400ms ease, transform 650ms ease;
  }

  .gallery-item--has-image .gallery-item-image {
    filter: contrast(1.05) brightness(0.92) saturate(1.05);
  }

  .gallery-item:focus-visible {
    transform: translateY(-3px) scale(1.008);
  }

  .gallery-item:focus-visible::before {
    opacity: 1;
  }

  /* Keyboard focus styles */
  .gallery-item:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 4px;
  }

  .gallery-item-content {
    position: relative;
    transition: transform 300ms ease;
  }

  .gallery-item-content--card {
    background: transparent;
  }

  .gallery-item-content--overlay {
    position: absolute;
    inset: auto 0 0 0;
    z-index: 2;
    padding: 1.5rem;
    padding-top: clamp(2.5rem, 5vw, 4.25rem);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    background: linear-gradient(
      180deg,
      rgba(5, 10, 24, 0) 0%,
      rgba(5, 10, 24, 0.45) 45%,
      rgba(4, 7, 16, 0.92) 100%
    );
    color: #f8fafc;
    text-shadow: 0 1px 2px rgba(1, 2, 6, 0.55);
    backdrop-filter: blur(12px) saturate(140%);
    -webkit-backdrop-filter: blur(12px) saturate(140%);
  }

  .gallery-item-content--overlay .theme-heading {
    color: #fff;
  }

  .gallery-item-content--overlay .theme-text-muted {
    color: rgba(248, 250, 252, 0.9);
  }

  .gallery-item-content--overlay .theme-chip {
    border-color: rgba(248, 250, 252, 0.35);
    background-color: rgba(15, 23, 42, 0.35);
    color: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(4px);
  }

  .gallery-item--no-image:focus-visible .gallery-item-content {
    transform: translateY(-4px);
  }

  .gallery-item--interactive:focus-visible .gallery-item-image {
    transform: scale(1.08);
  }

  .gallery-item--interactive:focus-visible .gallery-item-overlay,
  .gallery-item--interactive:focus-visible .gallery-item-hover-indicator {
    opacity: 1;
  }

  @media (hover: hover) and (pointer: fine) {
    .gallery-item--interactive:hover {
      transform: translateY(-4px) scale(1.01);
    }

    .gallery-item--interactive:hover::before {
      opacity: 1;
    }

    .gallery-item--interactive:hover .gallery-item-image {
      transform: scale(1.1);
    }

    .gallery-item--interactive:hover .gallery-item-overlay {
      opacity: 1;
    }

    .gallery-item--interactive:hover .gallery-item-hover-indicator {
      opacity: 1;
    }

    .gallery-item--interactive.gallery-item--no-image:hover .gallery-item-content {
      transform: translateY(-4px);
    }
  }

  @media (hover: none), (pointer: coarse) {
    .gallery-item-hover-indicator {
      opacity: 0.88;
    }

    .gallery-item-overlay {
      opacity: 0.25;
    }
  }

  @media (max-width: 640px) {
    .gallery-item-text {
      min-height: 180px;
    }

    .gallery-item-tall .gallery-item-image-wrapper {
      height: 21rem;
    }

    .gallery-item-wide .gallery-item-image-wrapper {
      height: 13rem;
    }

    .gallery-item:not(.gallery-item-text):not(.gallery-item-tall):not(.gallery-item-wide) .gallery-item-image-wrapper {
      height: 15rem;
    }

    .gallery-item-content--overlay {
      padding: 1.15rem;
      padding-top: clamp(2.2rem, 9vw, 3.4rem);
    }
  }

  @media (max-width: 420px) {
    .gallery-item-tall .gallery-item-image-wrapper {
      height: 19rem;
    }

    .gallery-item:not(.gallery-item-text):not(.gallery-item-tall):not(.gallery-item-wide) .gallery-item-image-wrapper {
      height: 13.5rem;
    }

    .gallery-item-content--overlay {
      padding: 1rem;
      padding-top: 2rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .gallery-item,
    .gallery-item::before,
    .gallery-item-image,
    .gallery-item-overlay,
    .gallery-item-content,
    .gallery-item-hover-indicator {
      transition: none !important;
    }
  }

</style>
