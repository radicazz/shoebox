---
import '../styles/global.css';
import TopBar from '../components/TopBar.astro';
const { title = 'Shoe Box' } = Astro.props;
---
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <link rel="icon" href="/favicon.ico" />
    <script is:inline>
      (function () {
        if (typeof window === 'undefined') return;
        const storageKey = 'shoebox-theme';
        const root = document.documentElement;
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

        const applyTheme = (theme) => {
          const next = theme === 'dark' ? 'dark' : 'light';
          root.dataset.theme = next;
          root.classList.toggle('dark', next === 'dark');
          return next;
        };

        const getStored = () => {
          try {
            return localStorage.getItem(storageKey);
          } catch (error) {
            console.warn('Theme storage unavailable', error);
            return null;
          }
        };

        const storeTheme = (theme) => {
          try {
            localStorage.setItem(storageKey, theme);
          } catch (error) {
            console.warn('Unable to persist theme preference', error);
          }
        };

        const getPreferredTheme = () => {
          const storedTheme = getStored();
          if (storedTheme) return storedTheme;
          return mediaQuery.matches ? 'dark' : 'light';
        };

        const notifyThemeChange = (theme, source = 'user') => {
          document.dispatchEvent(new CustomEvent('shoebox-theme-change', { detail: { theme, source } }));
        };

        const initialTheme = applyTheme(getPreferredTheme());
        notifyThemeChange(initialTheme, getStored() ? 'user' : 'system');

        const updateToggleButton = (button, theme) => {
          if (!button) return;
          const label = button.querySelector('[data-theme-toggle-label]');
          const isDark = theme === 'dark';
          button.setAttribute('aria-pressed', String(isDark));
          if (label) {
            label.textContent = isDark ? 'Switch to light mode' : 'Switch to dark mode';
          }
        };

        const updateToggleButtonStates = (theme) => {
          const buttons = document.querySelectorAll('[data-theme-toggle]');
          buttons.forEach((btn) => updateToggleButton(btn, theme));
        };

        const handleSystemThemeChange = (event) => {
          if (getStored()) return; // user override takes precedence
          const nextTheme = event.matches ? 'dark' : 'light';
          applyTheme(nextTheme);
          notifyThemeChange(nextTheme, 'system');
          updateToggleButtonStates(nextTheme);
        };

        const bindThemeToggles = () => {
          const buttons = Array.from(document.querySelectorAll('[data-theme-toggle]'));
          const sync = () => {
            const currentTheme = window.__shoeboxTheme.get();
            buttons.forEach((btn) => updateToggleButton(btn, currentTheme));
          };
          buttons.forEach((button) => {
            button.addEventListener('click', () => {
              const next = window.__shoeboxTheme.toggle();
              updateToggleButton(button, next);
            });
          });
          document.addEventListener('shoebox-theme-change', (event) => {
            const nextTheme = event.detail?.theme;
            if (!nextTheme) return;
            buttons.forEach((btn) => updateToggleButton(btn, nextTheme));
          });
          sync();
        };

        window.__shoeboxTheme = {
          set(theme) {
            const next = applyTheme(theme);
            storeTheme(next);
            notifyThemeChange(next, 'user');
            return next;
          },
          toggle() {
            const current = root.dataset.theme === 'dark' ? 'dark' : 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            return this.set(next);
          },
          clear() {
            try {
              localStorage.removeItem(storageKey);
            } catch (error) {
              console.warn('Unable to clear theme preference', error);
            }
            const next = applyTheme(getPreferredTheme());
            notifyThemeChange(next, 'system');
            updateToggleButtonStates(next);
            return next;
          },
          get() {
            return root.dataset.theme ?? 'light';
          },
        };

        const attachSystemListeners = () => {
          if (typeof mediaQuery.addEventListener === 'function') {
            mediaQuery.addEventListener('change', handleSystemThemeChange);
          } else if (typeof mediaQuery.addListener === 'function') {
            mediaQuery.addListener(handleSystemThemeChange);
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            bindThemeToggles();
            attachSystemListeners();
            updateToggleButtonStates(window.__shoeboxTheme.get());
          });
        } else {
          bindThemeToggles();
          attachSystemListeners();
          updateToggleButtonStates(window.__shoeboxTheme.get());
        }
      })();
    </script>
  </head>
  <body class="bg-gray-50 text-gray-900 antialiased transition-colors dark:bg-gray-900 dark:text-gray-100">
    <header class="sr-only"><h1>Shoe Box Gallery</h1></header>
    <TopBar siteName={title} />
    <main class="mx-auto w-full px-4 pb-8 pt-28 sm:pt-32 lg:max-w-[72vw] 2xl:max-w-6xl">
      <slot />
    </main>
    <footer class="mx-auto w-full px-4 pb-10 text-center text-sm text-gray-500 dark:text-gray-400 lg:max-w-[72vw] 2xl:max-w-6xl">
      made with <span aria-hidden="true" class="text-red-500">&hearts;</span> by cazz
      <span class="sr-only">made with love by cazz</span>
    </footer>
  </body>
</html>
